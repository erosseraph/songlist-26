<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šåˆ¶ä½ é«˜è´¨é‡çš„ä¸“å±æ­Œå…</title>
    
    <!-- æ·»åŠ è¿™äº› meta æ ‡ç­¾è§£å†³ Vercel éƒ¨ç½²é—®é¢˜ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com https://itunes.apple.com 'unsafe-inline' 'unsafe-eval';">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: #f50057;
            transform: translateY(-2px);
        }
        
        /* é¡µé¢å®¹å™¨ */
        .page-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 120px);
        }
        
        /* ç‚¹æ­Œç³»ç»Ÿé¡µé¢æ ·å¼ */
        #karaoke-page {
            display: flex;
            width: 100%;
            gap: 20px;
        }
        
        .browse-section {
            flex: 7;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .playlist-section {
            flex: 3;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .search-box button {
            padding: 10px 20px;
            background: #ff4081;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .search-box button:hover {
            background: #f50057;
            transform: translateY(-2px);
        }
        
        .charts-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px;
        }
        
        .chart-category {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
        }
        
        .chart-category:hover, .chart-category.active {
            background: #ff4081;
            transform: translateY(-3px);
        }
        
        .songs-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .song {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .song:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .song-info {
            flex: 1;
        }
        
        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .song-artist {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .song-album {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 3px;
        }
        
        .song-controls {
            display: flex;
            gap: 5px;
        }
        
        .add-btn, .preview-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preview-btn {
            background: #2196f3;
        }
        
        .add-btn:hover {
            background: #388e3c;
            transform: scale(1.1);
        }
        
        .preview-btn:hover {
            background: #0b7dda;
            transform: scale(1.1);
        }
        
        .playlist {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .playlist-items {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .playlist-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            transition: all 0.3s;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .playlist-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .song-number {
            width: 25px;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .remove-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        .playlist-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .playlist-controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .clear-btn {
            background: #f44336;
            color: white;
        }
        
        .share-btn {
            background: #2196f3;
            color: white;
        }
        
        .playlist-controls button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .playlist-pagination {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .playlist-pagination button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .playlist-pagination button:hover, .playlist-pagination button.active {
            background: #ff4081;
        }
        
        .empty-playlist {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .back-btn {
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        
        /* ä»·æ ¼é…å¥—é¡µé¢æ ·å¼ */
        #pricing-page {
            display: none;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .pricing-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .pricing-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .pricing-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px;
        }
        
        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .pricing-card.popular {
            border: 2px solid #ff4081;
            position: relative;
            transform: scale(1.05);
        }
        
        .popular-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4081;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .plan-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .song-range {
            font-size: 1.1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .price {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffeb3b;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .price small {
            font-size: 1rem;
            color: #fff;
            opacity: 0.8;
        }
        
        .select-btn {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
            margin-top: auto;
        }
        
        .select-btn:hover {
            background: #388e3c;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .shipping-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .shipping-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .shipping-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .shipping-option {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
        }
        
        .region {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .shipping-cost {
            font-size: 1.5rem;
            color: #ffeb3b;
            font-weight: bold;
        }
        
        .delivery-time {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .note {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
            opacity: 0.8;
        }
        
        .contact-info {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        
        .contact-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .contact-details {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        /* è®¢å•é¡µé¢æ ·å¼ */
        #order-page {
            display: none;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .order-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .playlist-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .playlist-preview-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .price-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffeb3b;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .cancel-btn, .submit-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .submit-btn {
            background: #4caf50;
            color: white;
        }
        
        .cancel-btn:hover, .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* éŸ³é¢‘æ’­æ”¾å™¨ */
        .audio-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .audio-player.hidden {
            display: none;
        }
        
        .audio-info {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .audio-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* ç”¨æˆ·ç™»å½•åŒºåŸŸ */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .login-btn, .logout-btn {
            padding: 8px 15px;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .login-btn:hover, .logout-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #1a2a6c;
        }
        
        .modal input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .modal button:hover {
            background: #0d1a4a;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* æ–°å¢çš„ç®¡ç†å‘˜é¡µé¢æ ·å¼ */
        .admin-panel {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffeb3b;
        }
        
        .orders-table {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .orders-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .orders-table th,
        .orders-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .orders-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending { background: #ff9800; }
        .status-confirmed { background: #2196f3; }
        .status-producing { background: #9c27b0; }
        .status-completed { background: #4caf50; }
        .status-cancelled { background: #f44336; }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 0.8rem;
        }
        
        .btn-edit { background: #2196f3; color: white; }
        .btn-cancel { background: #f44336; color: white; }
        .btn-complete { background: #4caf50; color: white; }
        
        /* ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† */
        .admin-login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .admin-login-content {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† */
        .order-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .order-detail-content {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .order-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }
        
        .order-detail-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1a2a6c;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .songs-container {
                grid-template-columns: 1fr;
            }
            
            .pricing-cards {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
                height: auto;
            }
            
            #karaoke-page {
                flex-direction: column;
            }
            
            .pricing-card.popular {
                transform: scale(1);
            }
            
            .shipping-details {
                flex-direction: column;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="close-btn" id="close-login">&times;</button>
            <h2>ç™»å½•/æ³¨å†Œ</h2>
            <p>ä½¿ç”¨é©¬æ¥è¥¿äºšç”µè¯å·ç ç™»å½•</p>
            <input type="tel" id="phone-input" placeholder="+60 12-345 6789" pattern="\+60[0-9]{8,10}">
            <button id="login-submit">ç™»å½•/æ³¨å†Œ</button>
            <p style="font-size: 0.8rem; margin-top: 10px; color: #666;">
                æç¤ºï¼šé©¬æ¥è¥¿äºšç”µè¯å·ç æ ¼å¼ä¸º +60 åæ¥8-10ä½æ•°å­—
            </p>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† -->
    <div class="admin-login-modal" id="admin-login-modal">
        <div class="admin-login-content">
            <button class="close-btn" id="close-admin-login">&times;</button>
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="password" id="admin-password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            <button id="admin-login-submit">ç™»å½•</button>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="order-detail-modal" id="order-detail-modal">
        <div class="order-detail-content">
            <button class="close-btn" id="close-order-detail">&times;</button>
            <h2>è®¢å•è¯¦æƒ…</h2>
            <div id="order-detail-content">
                <!-- è®¢å•è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="logo">ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…</div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ä»·æ ¼é…å¥—</button>
                <button class="nav-btn" id="admin-nav" style="display:none;">ç®¡ç†å‘˜åå°</button>
            </div>
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <span id="user-phone"></span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
                <button class="login-btn" id="admin-login-btn" style="margin-left:10px;">ç®¡ç†å‘˜</button>
            </div>
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- ç‚¹æ­Œç³»ç»Ÿé¡µé¢ -->
            <div id="karaoke-page">
                <section class="browse-section">
                    <h2 class="section-title">æ­Œæ›²æµè§ˆ</h2>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="æœç´¢æ­Œæ‰‹æˆ–æ­Œæ›²...">
                        <button id="search-btn">æœç´¢</button>
                    </div>
                    <div class="charts-container" id="charts-container">
                        <div class="chart-category active" data-category="chinese-pop">ä¸­æ–‡æµè¡Œ</div>
                        <div class="chart-category" data-category="western-pop">æ¬§ç¾æµè¡Œ</div>
                        <div class="chart-category" data-category="chinese-dj">ä¸­æ–‡DJ Remix</div>
                        <div class="chart-category" data-category="chinese-artists">ä¸­æ–‡æ­Œæ‰‹</div>
                        <div class="chart-category" data-category="western-artists">æ¬§ç¾æ­Œæ‰‹</div>
                    </div>
                    <div class="songs-container" id="songs-container">
                        <div class="empty-playlist">è¯·é€‰æ‹©æ’è¡Œæ¦œæˆ–æœç´¢æ­Œæ›²</div>
                    </div>
                </section>
                
                <section class="playlist-section">
                    <h2 class="section-title">æˆ‘çš„æ­Œå• <span id="playlist-count">(0)</span></h2>
                    <div class="playlist" id="playlist">
                        <div class="playlist-items" id="playlist-items">
                            <div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>
                        </div>
                        <div class="playlist-pagination" id="playlist-pagination"></div>
                    </div>
                    <div class="playlist-controls">
                        <button class="clear-btn" id="clear-btn">æ¸…ç©ºæ­Œå•</button>
                        <button class="share-btn" id="share-btn">åˆ†äº«æ­Œå•</button>
                    </div>
                </section>
            </div>
            
            <!-- ä»·æ ¼é…å¥—é¡µé¢ -->
            <div id="pricing-page">
                <div class="pricing-header">
                    <h1 class="pricing-title">ğŸµ ä»·æ ¼é…å¥—</h1>
                    <p class="pricing-subtitle">é€‰æ‹©é€‚åˆæ‚¨çš„æ­Œå•é…å¥—ï¼Œæ‰“é€ ä¸“å±éŸ³ä¹ä½“éªŒ</p>
                </div>
                
                <section class="pricing-section">
                    <h2 class="section-title">é€‰æ‹©æ‚¨çš„é…å¥—</h2>
                    <div class="pricing-cards">
                        <!-- åŸºç¡€ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">åŸºç¡€ç‰ˆ</div>
                            <div class="song-range">1 - 20 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>29</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- æ ‡å‡†ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">æ ‡å‡†ç‰ˆ</div>
                            <div class="song-range">21 - 50 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>49</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è¿›é˜¶ç‰ˆ -->
                        <div class="pricing-card popular">
                            <div class="popular-badge">æœ€å—æ¬¢è¿</div>
                            <div class="plan-name">è¿›é˜¶ç‰ˆ</div>
                            <div class="song-range">51 - 100 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>69</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è±ªåç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è±ªåç‰ˆ</div>
                            <div class="song-range">101 - 200 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>89</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- ä¸“ä¸šç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">ä¸“ä¸šç‰ˆ</div>
                            <div class="song-range">201 - 300 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>109</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- æ——èˆ°ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">æ——èˆ°ç‰ˆ</div>
                            <div class="song-range">301 - 400 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>129</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è‡³å°Šç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è‡³å°Šç‰ˆ</div>
                            <div class="song-range">401 - 500 é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>159</span></div>
                            <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                        </div>
                        
                        <!-- è‡ªå®šä¹‰ç‰ˆ -->
                        <div class="pricing-card">
                            <div class="plan-name">è‡ªå®šä¹‰ç‰ˆ</div>
                            <div class="song-range">501+ é¦–æ­Œæ›²</div>
                            <div class="price">RM<span>0.30</span><small>/æ¯é¦–</small></div>
                            <button class="select-btn">è”ç³»å®šåˆ¶</button>
                        </div>
                    </div>
                </section>
                
                <section class="shipping-info">
                    <h2 class="shipping-title">é…é€ä¿¡æ¯</h2>
                    <div class="shipping-details">
                        <div class="shipping-option">
                            <div class="region">è¥¿é©¬</div>
                            <div class="shipping-cost">å…è´¹é…é€</div>
                            <div class="delivery-time">é¢„è®¡ 5-7 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                        <div class="shipping-option">
                            <div class="region">ä¸œé©¬</div>
                            <div class="shipping-cost">RM 8.00</div>
                            <div class="delivery-time">é¢„è®¡ 7-10 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                    </div>
                    <p class="note">* æ‰€æœ‰é…å¥—å‡åŒ…å«å®Œæ•´çš„æŠ€æœ¯æ”¯æŒå’Œå”®åæœåŠ¡</p>
                </section>
                
                <section class="contact-info">
                    <h2 class="contact-title">éœ€è¦å¸®åŠ©ï¼Ÿ</h2>
                    <p class="contact-details">è”ç³»æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿï¼š</p>
                    <p class="contact-details">ğŸ“ ç”µè¯: +60 12-345 6789</p>
                    <p class="contact-details">âœ‰ï¸ é‚®ç®±: support@karaoke.com</p>
                    <p class="contact-details">ğŸ•’ æœåŠ¡æ—¶é—´: å‘¨ä¸€è‡³å‘¨æ—¥ 9:00 - 18:00</p>
                </section>
            </div>
            
            <!-- è®¢å•é¡µé¢ -->
            <div id="order-page">
                <div class="order-form">
                    <h2 class="section-title">å¡«å†™è®¢å•èµ„æ–™</h2>
                    
                    <div class="form-group">
                        <label for="customer-name">å§“å</label>
                        <input type="text" id="customer-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-phone">ç”µè¯å·ç </label>
                        <input type="tel" id="customer-phone" placeholder="+60 12-345 6789" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-address">æ”¶è´§åœ°å€</label>
                        <textarea id="customer-address" placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-state">å·å±</label>
                        <select id="customer-state" required>
                            <option value="">è¯·é€‰æ‹©å·å±</option>
                            <option value="west">è¥¿é©¬</option>
                            <option value="east">ä¸œé©¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-notes">å¤‡æ³¨ (å¯é€‰)</label>
                        <textarea id="customer-notes" placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨æ­¤å¤‡æ³¨" rows="3"></textarea>
                    </div>
                    
                    <div class="playlist-preview" id="order-playlist-preview">
                        <!-- æ­Œå•é¢„è§ˆå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="price-summary" id="price-summary">
                        <!-- ä»·æ ¼æ‘˜è¦å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="form-buttons">
                        <button class="cancel-btn" id="cancel-order">å–æ¶ˆ</button>
                        <button class="submit-btn" id="submit-order">ç¡®è®¤è®¢å•</button>
                    </div>
                </div>
            </div>
            
            <!-- ç®¡ç†å‘˜åå°é¡µé¢ -->
            <div id="admin-page" style="display:none;">
                <div class="admin-panel">
                    <div class="admin-header">
                        <h2 class="section-title">ç®¡ç†å‘˜åå°</h2>
                        <button class="logout-btn" id="admin-logout-btn">é€€å‡ºç®¡ç†å‘˜</button>
                    </div>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders">0</div>
                            <div>æ€»è®¢å•æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pending-orders">0</div>
                            <div>å¾…å¤„ç†è®¢å•</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="today-orders">0</div>
                            <div>ä»Šæ—¥è®¢å•</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-revenue">RM 0</div>
                            <div>æ€»æ”¶å…¥</div>
                        </div>
                    </div>
                    
                    <div class="orders-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>è®¢å•å·</th>
                                    <th>é¡¾å®¢å§“å</th>
                                    <th>ç”µè¯</th>
                                    <th>æ­Œæ›²æ•°é‡</th>
                                    <th>æ€»é‡‘é¢</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ä¸‹å•æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="admin-orders-list">
                                <!-- è®¢å•åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player hidden" id="audio-player">
        <div class="audio-info" id="audio-info">è¯•å¬ä¸­...</div>
        <div class="audio-controls">
            <button id="play-pause-btn">â¸ï¸</button>
            <button id="stop-btn">â¹ï¸</button>
        </div>
    </div>

<script>
    // ==================== Firebase åˆå§‹åŒ– ====================
    const firebaseConfig = {
        apiKey: "AIzaSyBoqtFkm8JRPdiIMjfojzSIETr4nw32NBI",
        authDomain: "karaokeorders-e1450.firebaseapp.com",
        projectId: "karaokeorders-e1450",
        storageBucket: "karaokeorders-e1450.firebasestorage.app",
        messagingSenderId: "318368431976",
        appId: "1:318368431976:web:5598144a764f2ccd4860dd"
    };

    // å®‰å…¨çš„ Firebase åˆå§‹åŒ–
    let db = null;
    let auth = null;
    let firebaseInitialized = false;

    // æ£€æŸ¥å½“å‰åŸŸå
    const currentDomain = window.location.hostname;
    const isVercelDeployment = currentDomain.includes('vercel.app');
    const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1';

    console.log('å½“å‰åŸŸå:', currentDomain);
    console.log('Vercel éƒ¨ç½²:', isVercelDeployment);
    console.log('æœ¬åœ°ç¯å¢ƒ:', isLocalhost);

    try {
        if (typeof window !== 'undefined' && typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            
            // é…ç½® Firebase ç”¨äº Vercel
            if (isVercelDeployment) {
                console.log('æ£€æµ‹åˆ° Vercel ç¯å¢ƒï¼Œåº”ç”¨ç‰¹æ®Šé…ç½®');
                // è®¾ç½®æ›´å®½æ¾çš„é…ç½®ä»¥é€‚åº” Vercel
                firebase.auth().useDeviceLanguage();
            }
            
            auth = firebase.auth;
            db = firebase.firestore;
            firebaseInitialized = true;
            console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
            
        } else {
            console.log('âš ï¸ ç¯å¢ƒä¸æ”¯æŒ Firebaseï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
        }
    } catch (error) {
        console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
        console.log('âš ï¸ ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
    }

    // ç®¡ç†å‘˜å¯†ç 
    const ADMIN_PASSWORD = "admin6959";

    // ==================== å…¨å±€å˜é‡ ====================
    let currentUser = null;
    let currentSongs = [];
    let playlist = [];
    let currentAudio = null;
    let isPlaying = false;
    let isSearchResultsView = false;
    let currentPlaylistPage = 1;
    const SONGS_PER_PAGE = 10;
    let isAdminLoggedIn = false;

    // ==================== DOMå…ƒç´  ====================
    const loginModal = document.getElementById('login-modal');
    const adminLoginModal = document.getElementById('admin-login-modal');
    const orderDetailModal = document.getElementById('order-detail-modal');
    const chartsContainer = document.getElementById('charts-container');
    const songsContainer = document.getElementById('songs-container');
    const playlistContainer = document.getElementById('playlist-items');
    const playlistPagination = document.getElementById('playlist-pagination');
    const playlistCount = document.getElementById('playlist-count');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const clearBtn = document.getElementById('clear-btn');
    const shareBtn = document.getElementById('share-btn');
    const audioPlayer = document.getElementById('audio-player');
    const audioInfo = document.getElementById('audio-info');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const adminNav = document.getElementById('admin-nav');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminPage = document.getElementById('admin-page');

    // ==================== Firebase æ•°æ®åº“æ“ä½œ ====================
    async function testFirebaseConnection() {
        if (!firebaseInitialized || !db) {
            console.log('âŒ Firebase æœªåˆå§‹åŒ–');
            return false;
        }
        
        try {
            console.log('æµ‹è¯• Firebase è¿æ¥...');
            const testRef = db().collection('connectionTest').doc('test');
            await testRef.set({
                timestamp: new Date(),
                domain: window.location.hostname,
                environment: isVercelDeployment ? 'vercel' : 'local'
            });
            console.log('âœ… Firebase è¿æ¥æµ‹è¯•æˆåŠŸ');
            
            // æ¸…ç†æµ‹è¯•æ–‡æ¡£
            await testRef.delete();
            return true;
        } catch (error) {
            console.error('âŒ Firebase è¿æ¥æµ‹è¯•å¤±è´¥:', error);
            
            // è¯¦ç»†é”™è¯¯ä¿¡æ¯
            if (error.code === 'permission-denied') {
                console.error('æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥ Firestore è§„åˆ™');
            } else if (error.code === 'unavailable') {
                console.error('ç½‘ç»œä¸å¯ç”¨');
            } else {
                console.error('é”™è¯¯ä»£ç :', error.code, 'é”™è¯¯ä¿¡æ¯:', error.message);
            }
            
            return false;
        }
    }

    // ä¿å­˜è®¢å•åˆ° Firebaseï¼ˆå¸¦æœ¬åœ°å­˜å‚¨å›é€€ï¼‰
    async function saveOrderToFirebase(order) {
        // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
        if (!firebaseInitialized || !db) {
            console.warn('Firestore æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºå›é€€');
            return saveOrderToLocalStorage(order);
        }
        
        try {
            console.log('æ­£åœ¨ä¿å­˜è®¢å•åˆ° Firebase:', order);
            await db().collection('orders').doc(order.orderId).set(order);
            console.log('âœ… è®¢å•ä¿å­˜æˆåŠŸï¼Œæ–‡æ¡£ID:', order.orderId);
            return true;
        } catch (error) {
            console.error('âŒ ä¿å­˜è®¢å•åˆ° Firebase å¤±è´¥:', error);
            console.warn('âš ï¸ ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºå›é€€');
            return saveOrderToLocalStorage(order);
        }
    }

    // æœ¬åœ°å­˜å‚¨å›é€€æ–¹æ¡ˆ
    function saveOrderToLocalStorage(order) {
        try {
            const orders = JSON.parse(localStorage.getItem('localOrders') || '[]');
            orders.push(order);
            localStorage.setItem('localOrders', JSON.stringify(orders));
            console.log('âœ… è®¢å•å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            return true;
        } catch (error) {
            console.error('âŒ æœ¬åœ°å­˜å‚¨ä¹Ÿå¤±è´¥äº†:', error);
            return false;
        }
    }

    // ä» Firebase åŠ è½½ç®¡ç†å‘˜æ•°æ®ï¼ˆå¸¦æœ¬åœ°å­˜å‚¨å›é€€ï¼‰
    async function loadAdminData() {
        // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½
        if (!firebaseInitialized || !db) {
            console.warn('Firestore æœªåˆå§‹åŒ–ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®');
            return loadAdminDataFromLocal();
        }
        
        try {
            const snapshot = await db().collection('orders').orderBy('orderDate', 'desc').get();
            const orders = snapshot.docs.map(doc => doc.data());
            renderAdminOrders(orders);
            updateAdminStats(orders);
        } catch (error) {
            console.error('âŒ ä» Firebase åŠ è½½æ•°æ®å¤±è´¥:', error);
            console.warn('âš ï¸ ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®');
            loadAdminDataFromLocal();
        }
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç®¡ç†å‘˜æ•°æ®
    function loadAdminDataFromLocal() {
        try {
            const orders = JSON.parse(localStorage.getItem('localOrders') || '[]');
            renderAdminOrders(orders);
            updateAdminStats(orders);
        } catch (error) {
            console.error('âŒ ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®å¤±è´¥:', error);
        }
    }

    // æ›´æ–°è®¢å•çŠ¶æ€
    async function updateOrderStatus(orderId, newStatus) {
        // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œæ›´æ–°æœ¬åœ°å­˜å‚¨
        if (!firebaseInitialized || !db) {
            console.warn('Firestore æœªåˆå§‹åŒ–ï¼Œæ›´æ–°æœ¬åœ°å­˜å‚¨ä¸­çš„è®¢å•çŠ¶æ€');
            return updateOrderStatusInLocal(orderId, newStatus);
        }
        
        try {
            await db().collection('orders').doc(orderId).update({
                status: newStatus,
                updatedAt: new Date().toISOString()
            });
            console.log('âœ… è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
            return true;
        } catch (error) {
            console.error('âŒ æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
            return false;
        }
    }

    // åœ¨æœ¬åœ°å­˜å‚¨ä¸­æ›´æ–°è®¢å•çŠ¶æ€
    function updateOrderStatusInLocal(orderId, newStatus) {
        try {
            const orders = JSON.parse(localStorage.getItem('localOrders') || '[]');
            const orderIndex = orders.findIndex(order => order.orderId === orderId);
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                orders[orderIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('localOrders', JSON.stringify(orders));
                console.log('âœ… æœ¬åœ°å­˜å‚¨è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                return true;
            }
            return false;
        } catch (error) {
            console.error('âŒ æœ¬åœ°å­˜å‚¨è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            return false;
        }
    }

    // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    function checkFirestoreStatus() {
        if (!firebaseInitialized) {
            showMessage('æ•°æ®åº“æœªå°±ç»ªï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼', 'warning');
            return false;
        }
        return true;
    }

    // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
    document.getElementById('karaoke-nav').addEventListener('click', function() {
        showPage('karaoke');
        setActiveNav(this);
    });
    
    document.getElementById('pricing-nav').addEventListener('click', function() {
        showPage('pricing');
        setActiveNav(this);
    });

    document.getElementById('admin-nav').addEventListener('click', function() {
        showPage('admin');
        setActiveNav(this);
    });
    
    function showPage(page) {
        document.getElementById('karaoke-page').style.display = page === 'karaoke' ? 'flex' : 'none';
        document.getElementById('pricing-page').style.display = page === 'pricing' ? 'block' : 'none';
        document.getElementById('order-page').style.display = page === 'order' ? 'block' : 'none';
        document.getElementById('admin-page').style.display = page === 'admin' ? 'block' : 'none';
    }
    
    function setActiveNav(activeButton) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    // ==================== ç”¨æˆ·è®¤è¯åŠŸèƒ½ ====================
    function checkUserLogin() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = savedUser;
            updateUserUI();
            loadUserPlaylist();
        }
        
        // æ£€æŸ¥Firebaseè®¤è¯çŠ¶æ€
        if (firebaseInitialized && auth) {
            auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user.phoneNumber;
                    updateUserUI();
                    loadUserPlaylist();
                }
            });
        }
    }
    
    function updateUserUI() {
        if (currentUser) {
            document.getElementById('user-phone').textContent = currentUser;
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-btn').style.display = 'none';
        } else {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('login-btn').style.display = 'block';
        }
    }
    
    // ç™»å½•åŠŸèƒ½
    document.getElementById('login-submit').addEventListener('click', function() {
        const phone = document.getElementById('phone-input').value.trim();
        const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
        
        if (!malaysiaPhoneRegex.test(phone)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
            return;
        }
        
        currentUser = phone;
        localStorage.setItem('currentUser', currentUser);
        updateUserUI();
        loginModal.style.display = 'none';
        loadUserPlaylist();
        showMessage(`æ¬¢è¿å›æ¥ï¼${phone}`);
    });
    
    document.getElementById('logout-btn').addEventListener('click', function() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUserUI();
        playlist = [];
        renderPlaylist();
        updatePlaylistCount();
        showMessage('å·²é€€å‡ºç™»å½•');
    });

    // ==================== ç®¡ç†å‘˜åŠŸèƒ½ ====================
    document.getElementById('admin-login-btn').addEventListener('click', function() {
        adminLoginModal.style.display = 'flex';
    });
    
    document.getElementById('admin-login-submit').addEventListener('click', function() {
        const password = document.getElementById('admin-password').value;
        if (password === ADMIN_PASSWORD) {
            isAdminLoggedIn = true;
            adminLoginModal.style.display = 'none';
            adminNav.style.display = 'block';
            showPage('admin');
            setActiveNav(document.getElementById('admin-nav'));
            loadAdminData();
            showMessage('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
        } else {
            alert('å¯†ç é”™è¯¯');
        }
    });
    
    document.getElementById('admin-logout-btn').addEventListener('click', function() {
        isAdminLoggedIn = false;
        adminNav.style.display = 'none';
        showPage('karaoke');
        setActiveNav(document.getElementById('karaoke-nav'));
        showMessage('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
    });

    // ==================== ç®¡ç†å‘˜ç•Œé¢æ¸²æŸ“ ====================
    function renderAdminOrders(orders) {
        const tbody = document.getElementById('admin-orders-list');
        tbody.innerHTML = '';
        
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">æš‚æ— è®¢å•</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            const orderDate = new Date(order.orderDate);
            const statusClass = `status-${order.status}`;
            
            tr.innerHTML = `
                <td>${order.orderId}</td>
                <td>${order.customerInfo.name}</td>
                <td>${order.customerInfo.phone}</td>
                <td>${order.playlist.count} é¦–</td>
                <td>RM ${order.pricing.totalPrice.toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${getStatusText(order.status)}</span></td>
                <td>${orderDate.toLocaleString('zh-CN')}</td>
                <td>
                    <button class="action-btn btn-edit" onclick="viewOrderDetail('${order.orderId}')">æŸ¥çœ‹</button>
                    ${order.status === 'pending' ? 
                        `<button class="action-btn btn-complete" onclick="updateOrderStatus('${order.orderId}', 'confirmed')">ç¡®è®¤</button>
                         <button class="action-btn btn-cancel" onclick="updateOrderStatus('${order.orderId}', 'cancelled')">å–æ¶ˆ</button>` : 
                     order.status === 'confirmed' ? 
                        `<button class="action-btn btn-complete" onclick="updateOrderStatus('${order.orderId}', 'producing')">åˆ¶ä½œä¸­</button>` :
                     order.status === 'producing' ? 
                        `<button class="action-btn btn-complete" onclick="updateOrderStatus('${order.orderId}', 'completed')">å®Œæˆ</button>` :
                     ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateAdminStats(orders) {
        const totalOrders = orders.length;
        const pendingOrders = orders.filter(order => order.status === 'pending').length;
        const todayOrders = orders.filter(order => 
            new Date(order.orderDate).toDateString() === new Date().toDateString()
        ).length;
        const totalRevenue = orders.reduce((sum, order) => sum + order.pricing.totalPrice, 0);
        
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('pending-orders').textContent = pendingOrders;
        document.getElementById('today-orders').textContent = todayOrders;
        document.getElementById('total-revenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': 'å¾…å¤„ç†',
            'confirmed': 'å·²ç¡®è®¤',
            'producing': 'åˆ¶ä½œä¸­',
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
        };
        return statusMap[status] || status;
    }

    // ==================== è®¢å•è¯¦æƒ…åŠŸèƒ½ ====================
    async function viewOrderDetail(orderId) {
        // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½
        if (!firebaseInitialized || !db) {
            console.warn('Firestore æœªåˆå§‹åŒ–ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¢å•è¯¦æƒ…');
            return viewOrderDetailFromLocal(orderId);
        }
        
        try {
            const doc = await db().collection('orders').doc(orderId).get();
            if (doc.exists) {
                const order = doc.data();
                renderOrderDetail(order);
                orderDetailModal.style.display = 'flex';
            }
        } catch (error) {
            console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        }
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¢å•è¯¦æƒ…
    function viewOrderDetailFromLocal(orderId) {
        try {
            const orders = JSON.parse(localStorage.getItem('localOrders') || '[]');
            const order = orders.find(order => order.orderId === orderId);
            if (order) {
                renderOrderDetail(order);
                orderDetailModal.style.display = 'flex';
            } else {
                alert('æœªæ‰¾åˆ°è¯¥è®¢å•');
            }
        } catch (error) {
            console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        }
    }

    function renderOrderDetail(order) {
        const container = document.getElementById('order-detail-content');
        const orderDate = new Date(order.orderDate);
        
        container.innerHTML = `
            <div class="order-detail-section">
                <h3 class="order-detail-title">è®¢å•ä¿¡æ¯</h3>
                <p><strong>è®¢å•å·:</strong> ${order.orderId}</p>
                <p><strong>çŠ¶æ€:</strong> <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></p>
                <p><strong>ä¸‹å•æ—¶é—´:</strong> ${orderDate.toLocaleString('zh-CN')}</p>
            </div>
            
            <div class="order-detail-section">
                <h3 class="order-detail-title">é¡¾å®¢ä¿¡æ¯</h3>
                <p><strong>å§“å:</strong> ${order.customerInfo.name}</p>
                <p><strong>ç”µè¯:</strong> ${order.customerInfo.phone}</p>
                <p><strong>åœ°å€:</strong> ${order.customerInfo.address}</p>
                <p><strong>å·å±:</strong> ${order.customerInfo.state === 'west' ? 'è¥¿é©¬' : 'ä¸œé©¬'}</p>
                ${order.customerInfo.notes ? `<p><strong>å¤‡æ³¨:</strong> ${order.customerInfo.notes}</p>` : ''}
            </div>
            
            <div class="order-detail-section">
                <h3 class="order-detail-title">æ­Œå•ä¿¡æ¯</h3>
                <p><strong>æ­Œæ›²æ•°é‡:</strong> ${order.playlist.count} é¦–</p>
                <p><strong>é…å¥—:</strong> ${order.pricing.package}</p>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    ${order.playlist.songs.map((song, index) => `
                        <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                            ${index + 1}. ${song.title} - ${song.artist}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="order-detail-section">
                <h3 class="order-detail-title">ä»·æ ¼ä¿¡æ¯</h3>
                <p><strong>é…å¥—ä»·æ ¼:</strong> RM ${order.pricing.packagePrice.toFixed(2)}</p>
                <p><strong>é‚®è´¹:</strong> ${order.pricing.shippingFee === 0 ? 'å…è´¹' : `RM ${order.pricing.shippingFee.toFixed(2)}`}</p>
                <p><strong>æ€»è´¹ç”¨:</strong> RM ${order.pricing.totalPrice.toFixed(2)}</p>
            </div>
        `;
    }

    // ==================== æµè§ˆå™¨é€šçŸ¥ ====================
    function showBrowserNotification(message) {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("æ–°è®¢å•é€šçŸ¥", {
                body: message,
                icon: "https://cdn-icons-png.flaticon.com/512/2921/2921815.png"
            });
        }
    }

    // è¯·æ±‚é€šçŸ¥æƒé™
    if ("Notification" in window) {
        Notification.requestPermission();
    }

    // ==================== ç‚¹æ­Œç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ ====================
    function initKaraoke() {
        setupEventListeners();
        updatePlaylistCount();
        loadChart('chinese-pop');
        
        // æµ‹è¯• Firebase è¿æ¥
        setTimeout(() => {
            testFirebaseConnection().then(success => {
                if (success) {
                    showMessage('ç³»ç»Ÿè¿æ¥æ­£å¸¸', 'success');
                } else {
                    showMessage('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'warning');
                }
            });
        }, 1000);
    }

    // ä½¿ç”¨iTunes APIæœç´¢éŸ³ä¹
    async function searchMusic(term, category = 'musicTrack', limit = 100) {
        try {
            showLoading('æ­£åœ¨æœç´¢...');
            
            const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=${category}&limit=${limit}&country=CN`);
            
            if (!response.ok) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
            
            const data = await response.json();
            
            if (data.resultCount === 0) {
                showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœ');
                return [];
            }
            
            return data.results.map(track => ({
                id: track.trackId || Math.random().toString(36).substr(2, 9),
                title: track.trackName || 'æœªçŸ¥æ­Œæ›²',
                artist: track.artistName || 'æœªçŸ¥æ­Œæ‰‹',
                album: track.collectionName || 'æœªçŸ¥ä¸“è¾‘',
                duration: track.trackTimeMillis,
                previewUrl: track.previewUrl,
                artwork: track.artworkUrl100
            }));
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            showError('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
            return [];
        }
    }

    // åŠ è½½æ’è¡Œæ¦œ
    async function loadChart(category) {
        isSearchResultsView = false;
        let searchTerm = '';
        let entityType = 'musicTrack';
        let limit = 100;
        
        switch(category) {
            case 'chinese-pop':
                searchTerm = 'popular chinese songs 2023 2024';
                break;
            case 'western-pop':
                searchTerm = 'pop music 2023 2024';
                break;
            case 'chinese-dj':
                searchTerm = 'chinese remix dj';
                break;
            case 'chinese-artists':
                renderArtistsList([
                    'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 
                    'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿',
                    'äº”æœˆå¤©', 'å¼ å­¦å‹', 'åˆ˜å¾·å', 'ç‹è²', 'å¼ æ°',
                    'è®¸åµ©', 'æ±ªè‹æ³·', 'å¾ä½³è¹', 'æ¨å®—çº¬', 'è§æ•¬è…¾'
                ]);
                return;
            case 'western-artists':
                renderArtistsList([
                    'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish',
                    'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars'
                ]);
                return;
        }
        
        currentSongs = await searchMusic(searchTerm, entityType, limit);
        renderSongs(currentSongs);
        
        document.querySelectorAll('.chart-category').forEach(chart => {
            chart.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');
    }

    // æ¸²æŸ“æ­Œæ‰‹åˆ—è¡¨
    function renderArtistsList(artists) {
        songsContainer.innerHTML = '';
        
        artists.forEach(artist => {
            const artistElement = document.createElement('div');
            artistElement.className = 'song';
            artistElement.innerHTML = `
                <div class="song-info">
                    <div class="song-title">${artist}</div>
                    <div class="song-artist">æ­Œæ‰‹</div>
                </div>
                <div class="song-controls">
                    <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                </div>
            `;
            songsContainer.appendChild(artistElement);
        });
    }

    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
    function renderSongs(songs) {
        songsContainer.innerHTML = '';
        
        if (songs.length === 0) {
            songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
            return;
        }
        
        if (isSearchResultsView) {
            const backButton = document.createElement('button');
            backButton.className = 'back-btn';
            backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
            backButton.addEventListener('click', () => {
                isSearchResultsView = false;
                loadChart('chinese-pop');
            });
            songsContainer.appendChild(backButton);
        }
        
        songs.forEach(song => {
            const songElement = document.createElement('div');
            songElement.className = 'song';
            songElement.innerHTML = `
                <div class="song-info">
                    <div class="song-title">${song.title}</div>
                    <div class="song-artist">${song.artist}</div>
                    <div class="song-album">${song.album}</div>
                </div>
                <div class="song-controls">
                    ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}">â–¶ï¸</button>` : ''}
                    <button class="add-btn" data-id="${song.id}">+</button>
                </div>
            `;
            songsContainer.appendChild(songElement);
        });
    }

    // æ¸²æŸ“æ­Œå•
    function renderPlaylist() {
        playlistContainer.innerHTML = '';
        
        if (playlist.length === 0) {
            playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
            renderPlaylistPagination();
            return;
        }
        
        const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
        const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
        const currentSongs = playlist.slice(startIndex, endIndex);
        
        currentSongs.forEach((song, index) => {
            const globalIndex = startIndex + index;
            const playlistItem = document.createElement('div');
            playlistItem.className = 'playlist-item';
            playlistItem.draggable = true;
            playlistItem.dataset.index = globalIndex;
            playlistItem.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="song-number">${globalIndex + 1}</div>
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                </div>
                <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
            `;
            playlistContainer.appendChild(playlistItem);
        });
        
        renderPlaylistPagination();
        setupDragAndDrop();
    }

    // æ¸²æŸ“æ­Œå•åˆ†é¡µ
    function renderPlaylistPagination() {
        playlistPagination.innerHTML = '';
        
        if (playlist.length <= SONGS_PER_PAGE) {
            return;
        }
        
        const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
        
        if (currentPlaylistPage > 1) {
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ä¸Šä¸€é¡µ';
            prevButton.addEventListener('click', () => {
                currentPlaylistPage--;
                renderPlaylist();
            });
            playlistPagination.appendChild(prevButton);
        }
        
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.classList.toggle('active', i === currentPlaylistPage);
            pageButton.addEventListener('click', () => {
                currentPlaylistPage = i;
                renderPlaylist();
            });
            playlistPagination.appendChild(pageButton);
        }
        
        if (currentPlaylistPage < totalPages) {
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ä¸‹ä¸€é¡µ';
            nextButton.addEventListener('click', () => {
                currentPlaylistPage++;
                renderPlaylist();
            });
            playlistPagination.appendChild(nextButton);
        }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        chartsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('chart-category')) {
                const category = e.target.dataset.category;
                loadChart(category);
            }
        });
        
        songsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-btn')) {
                const songId = e.target.dataset.id;
                const artist = e.target.dataset.artist;
                
                if (artist) {
                    performSearch(artist);
                } else if (songId) {
                    addSongToPlaylist(songId);
                }
            } else if (e.target.classList.contains('preview-btn')) {
                const songId = e.target.dataset.id;
                previewSong(songId);
            }
        });
        
        playlistContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const index = parseInt(e.target.dataset.index);
                removeSongFromPlaylist(index);
            }
        });
        
        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query) {
                performSearch(query);
            }
        });
        
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query) {
                    performSearch(query);
                }
            }
        });
        
        clearBtn.addEventListener('click', clearPlaylist);
        shareBtn.addEventListener('click', sharePlaylist);
        
        playPauseBtn.addEventListener('click', togglePlayPause);
        stopBtn.addEventListener('click', stopAudio);
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch(query) {
        isSearchResultsView = true;
        currentSongs = await searchMusic(query, 'musicTrack', 200);
        renderSongs(currentSongs);
    }

    // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
    function addSongToPlaylist(songId) {
        const song = currentSongs.find(s => s.id == songId);
        
        if (song) {
            if (!playlist.some(s => s.id == songId)) {
                playlist.push({...song});
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                
                if (currentUser) {
                    saveUserPlaylist();
                }
            } else {
                showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
            }
        } else {
            showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
        }
    }

    // ä»æ­Œå•ç§»é™¤æ­Œæ›²
    function removeSongFromPlaylist(index) {
        if (index >= 0 && index < playlist.length) {
            const songTitle = playlist[index].title;
            playlist.splice(index, 1);
            
            const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                currentPlaylistPage--;
            }
            
            renderPlaylist();
            updatePlaylistCount();
            showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
            
            if (currentUser) {
                saveUserPlaylist();
            }
        }
    }

    // ä¿å­˜ç”¨æˆ·æ­Œå•
    function saveUserPlaylist() {
        if (!currentUser) return;
        
        try {
            localStorage.setItem(`playlist_${currentUser}`, JSON.stringify(playlist));
        } catch (e) {
            console.error('ä¿å­˜æ­Œå•å¤±è´¥:', e);
        }
    }

    // åŠ è½½ç”¨æˆ·æ­Œå•
    function loadUserPlaylist() {
        if (!currentUser) return;
        
        const savedPlaylist = localStorage.getItem(`playlist_${currentUser}`);
        if (savedPlaylist) {
            try {
                playlist = JSON.parse(savedPlaylist);
                renderPlaylist();
                updatePlaylistCount();
            } catch (e) {
                console.error('åŠ è½½æ­Œå•å¤±è´¥:', e);
            }
        }
    }

    // è¯•å¬æ­Œæ›²
    function previewSong(songId) {
        const song = currentSongs.find(s => s.id == songId);
        
        if (song && song.previewUrl) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            currentAudio = new Audio(song.previewUrl);
            
            currentAudio.play();
            isPlaying = true;
            playPauseBtn.textContent = "â¸ï¸";
            
            audioPlayer.classList.remove('hidden');
            audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
            
            showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
            
            currentAudio.addEventListener('ended', () => {
                stopAudio();
            });
        } else {
            showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
        }
    }

    // åˆ‡æ¢æ’­æ”¾/æš‚åœ
    function togglePlayPause() {
        if (currentAudio) {
            if (isPlaying) {
                currentAudio.pause();
                playPauseBtn.textContent = "â–¶ï¸";
            } else {
                currentAudio.play();
                playPauseBtn.textContent = "â¸ï¸";
            }
            isPlaying = !isPlaying;
        }
    }

    // åœæ­¢éŸ³é¢‘
    function stopAudio() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            isPlaying = false;
            playPauseBtn.textContent = "â–¶ï¸";
            audioPlayer.classList.add('hidden');
        }
    }

    // æ¸…ç©ºæ­Œå•
    function clearPlaylist() {
        if (playlist.length === 0) {
            showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
            return;
        }
        
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
            playlist = [];
            currentPlaylistPage = 1;
            renderPlaylist();
            updatePlaylistCount();
            showMessage('æ­Œå•å·²æ¸…ç©º');
            
            if (currentUser) {
                saveUserPlaylist();
            }
        }
    }

    // åˆ†äº«æ­Œå• - è½¬è·³åˆ°è®¢å•é¡µé¢
    function sharePlaylist() {
        if (playlist.length === 0) {
            showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«');
            return;
        }
        
        if (!currentUser) {
            showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œåˆ†äº«æ­Œå•');
            loginModal.style.display = 'flex';
            return;
        }
        
        showOrderPage();
    }

    // æ˜¾ç¤ºè®¢å•é¡µé¢
    function showOrderPage() {
        showPage('order');
        setActiveNav(null);
        
        document.getElementById('customer-phone').value = currentUser;
        renderOrderPlaylistPreview();
        calculateAndDisplayPrice();
    }

    // æ¸²æŸ“è®¢å•é¡µé¢çš„æ­Œå•é¢„è§ˆ
    function renderOrderPlaylistPreview() {
        const previewContainer = document.getElementById('order-playlist-preview');
        previewContainer.innerHTML = '';
        
        if (playlist.length === 0) {
            previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
            return;
        }
        
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr style="background: rgba(255,255,255,0.1);">
                <th style="padding: 10px; text-align: left; width: 10%;">åºå·</th>
                <th style="padding: 10px; text-align: left; width: 45%;">æ­Œæ›²åç§°</th>
                <th style="padding: 10px; text-align: left; width: 35%;">æ­Œæ‰‹</th>
                <th style="padding: 10px; text-align: left; width: 10%;">æ—¶é•¿</th>
            </tr>
        `;
        table.appendChild(thead);
        
        const tbody = document.createElement('tbody');
        const displaySongs = playlist.slice(0, 15);
        
        displaySongs.forEach((song, index) => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            
            let durationText = 'æœªçŸ¥';
            if (song.duration) {
                const minutes = Math.floor(song.duration / 60000);
                const seconds = Math.floor((song.duration % 60000) / 1000);
                durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            row.innerHTML = `
                <td style="padding: 10px;">${index + 1}</td>
                <td style="padding: 10px;">${song.title}</td>
                <td style="padding: 10px;">${song.artist}</td>
                <td style="padding: 10px;">${durationText}</td>
            `;
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        previewContainer.appendChild(table);
        
        if (playlist.length > 15) {
            const moreElement = document.createElement('div');
            moreElement.style.textAlign = 'center';
            moreElement.style.padding = '10px';
            moreElement.style.fontStyle = 'italic';
            moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 15} é¦–æ­Œæ›²`;
            previewContainer.appendChild(moreElement);
        }
        
        const countElement = document.createElement('div');
        countElement.style.textAlign = 'center';
        countElement.style.padding = '15px';
        countElement.style.fontWeight = 'bold';
        countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
        countElement.style.marginTop = '10px';
        countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
        previewContainer.appendChild(countElement);
    }

    // è®¡ç®—å¹¶æ˜¾ç¤ºä»·æ ¼
    function calculateAndDisplayPrice() {
        const songCount = playlist.length;
        const state = document.getElementById('customer-state').value;
        
        let packageName, packagePrice;
        if (songCount <= 20) {
            packageName = "åŸºç¡€ç‰ˆ";
            packagePrice = 29;
        } else if (songCount <= 50) {
            packageName = "æ ‡å‡†ç‰ˆ";
            packagePrice = 49;
        } else if (songCount <= 100) {
            packageName = "è¿›é˜¶ç‰ˆ";
            packagePrice = 69;
        } else if (songCount <= 200) {
            packageName = "è±ªåç‰ˆ";
            packagePrice = 89;
        } else if (songCount <= 300) {
            packageName = "ä¸“ä¸šç‰ˆ";
            packagePrice = 109;
        } else if (songCount <= 400) {
            packageName = "æ——èˆ°ç‰ˆ";
            packagePrice = 129;
        } else if (songCount <= 500) {
            packageName = "è‡³å°Šç‰ˆ";
            packagePrice = 159;
        } else {
            packageName = "è‡ªå®šä¹‰ç‰ˆ";
            packagePrice = songCount * 0.3;
        }
        
        let shippingFee = 0;
        let shippingText = 'å…è´¹';
        if (state === 'east') {
            shippingFee = 8;
            shippingText = 'RM 8.00';
        }
        
        const totalPrice = packagePrice + shippingFee;
        
        const priceSummary = document.getElementById('price-summary');
        priceSummary.innerHTML = `
            <div class="price-row">
                <span>æ¨èé…å¥—ï¼š</span>
                <span>${packageName}</span>
            </div>
            <div class="price-row">
                <span>æ­Œæ›²æ•°é‡ï¼š</span>
                <span>${songCount} é¦–</span>
            </div>
            <div class="price-row">
                <span>é…å¥—ä»·æ ¼ï¼š</span>
                <span>RM ${packagePrice.toFixed(2)}</span>
            </div>
            <div class="price-row">
                <span>é…é€åœ°åŒºï¼š</span>
                <span>${state === 'west' ? 'è¥¿é©¬' : 'ä¸œé©¬'}</span>
            </div>
            <div class="price-row">
                <span>é‚®è´¹ï¼š</span>
                <span>${shippingText}</span>
            </div>
            <div class="price-row total-price">
                <span>æ€»è´¹ç”¨ï¼š</span>
                <span>RM ${totalPrice.toFixed(2)}</span>
            </div>
        `;
    }

    // åˆ›å»ºè®¢å•
    async function createOrder(name, phone, address, state) {
        const songCount = playlist.length;
        const notes = document.getElementById('customer-notes').value.trim();
        
        let packageName, packagePrice;
        if (songCount <= 20) {
            packageName = "åŸºç¡€ç‰ˆ";
            packagePrice = 29;
        } else if (songCount <= 50) {
            packageName = "æ ‡å‡†ç‰ˆ";
            packagePrice = 49;
        } else if (songCount <= 100) {
            packageName = "è¿›é˜¶ç‰ˆ";
            packagePrice = 69;
        } else if (songCount <= 200) {
            packageName = "è±ªåç‰ˆ";
            packagePrice = 89;
        } else if (songCount <= 300) {
            packageName = "ä¸“ä¸šç‰ˆ";
            packagePrice = 109;
        } else if (songCount <= 400) {
            packageName = "æ——èˆ°ç‰ˆ";
            packagePrice = 129;
        } else if (songCount <= 500) {
            packageName = "è‡³å°Šç‰ˆ";
            packagePrice = 159;
        } else {
            packageName = "è‡ªå®šä¹‰ç‰ˆ";
            packagePrice = songCount * 0.3;
        }
        
        let shippingFee = 0;
        if (state === 'east') {
            shippingFee = 8;
        }
        
        const totalPrice = packagePrice + shippingFee;
        
        const orderId = 'KTV' + new Date().getTime();
        
        const order = {
            orderId: orderId,
            customerInfo: {
                name: name,
                phone: phone,
                address: address,
                state: state,
                notes: notes
            },
            playlist: {
                count: songCount,
                songs: [...playlist],
                package: packageName
            },
            pricing: {
                package: packageName,
                songCount: songCount,
                packagePrice: packagePrice,
                shippingFee: shippingFee,
                totalPrice: totalPrice
            },
            orderDate: new Date().toISOString(),
            status: 'pending'
        };
        
        const success = await saveOrderToFirebase(order);
        
        if (success) {
            alert(`è®¢å•æäº¤æˆåŠŸï¼\nè®¢å•ç¼–å·: ${orderId}\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬çš„å®¢æœå°†å¾ˆå¿«è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
            
            showPage('karaoke');
            setActiveNav(document.getElementById('karaoke-nav'));
            
            playlist = [];
            renderPlaylist();
            updatePlaylistCount();
            saveUserPlaylist();
        } else {
            alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ');
        }
    }

    // è®¾ç½®æ‹–æ‹½æ’åº
    function setupDragAndDrop() {
        const items = playlistContainer.querySelectorAll('.playlist-item');
        
        items.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.dataset.index);
                setTimeout(() => item.classList.add('dragging'), 0);
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
            });
        });
        
        playlistContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(playlistContainer, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable && afterElement) {
                playlistContainer.insertBefore(draggable, afterElement);
            } else if (draggable) {
                playlistContainer.appendChild(draggable);
            }
        });
        
        playlistContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const items = Array.from(playlistContainer.querySelectorAll('.playlist-item'));
            const toIndex = items.findIndex(item => item.classList.contains('dragging'));
            
            if (fromIndex !== toIndex && toIndex !== -1) {
                const [movedItem] = playlist.splice(fromIndex, 1);
                playlist.splice(toIndex, 0, movedItem);
                
                renderPlaylist();
                showMessage('æ­Œå•é¡ºåºå·²æ›´æ–°');
                
                if (currentUser) {
                    saveUserPlaylist();
                }
            }
        });
    }

    // è·å–æ‹–æ‹½åçš„å…ƒç´ ä½ç½®
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // æ›´æ–°æ­Œå•è®¡æ•°
    function updatePlaylistCount() {
        playlistCount.textContent = `(${playlist.length})`;
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type = 'info') {
        const messageEl = document.createElement('div');
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'warning' ? 'rgba(255, 152, 0, 0.9)' : type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(0, 0, 0, 0.8)'};
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            z-index: 1000;
            transition: all 0.3s;
            max-width: 300px;
            word-wrap: break-word;
        `;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(message) {
        songsContainer.innerHTML = `<div class="loading">${message}</div>`;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
        songsContainer.innerHTML = `<div class="error">${message}</div>`;
    }

    // ==================== è®¢å•åŠŸèƒ½äº‹ä»¶ç›‘å¬ ====================
    document.getElementById('customer-state').addEventListener('change', calculateAndDisplayPrice);
    
    document.getElementById('cancel-order').addEventListener('click', function() {
        showPage('karaoke');
        setActiveNav(document.getElementById('karaoke-nav'));
    });
    
    document.getElementById('submit-order').addEventListener('click', function() {
        const name = document.getElementById('customer-name').value.trim();
        const phone = document.getElementById('customer-phone').value.trim();
        const address = document.getElementById('customer-address').value.trim();
        const state = document.getElementById('customer-state').value;
        
        if (!name || !phone || !address || !state) {
            alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
            return;
        }
        
        const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
        if (!malaysiaPhoneRegex.test(phone)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
            return;
        }
        
        createOrder(name, phone, address, state);
    });

    // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å¼€å§‹...');
        console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent);
        
        initKaraoke();
        checkUserLogin();
        
        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        if (isVercelDeployment) {
            console.log('ğŸŒ è¿è¡Œåœ¨ Vercel ç¯å¢ƒ');
            document.title += ' - Vercel';
        }
        
        // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        document.getElementById('close-admin-login').addEventListener('click', function() {
            adminLoginModal.style.display = 'none';
        });
        
        document.getElementById('close-order-detail').addEventListener('click', function() {
            orderDetailModal.style.display = 'none';
        });

        document.getElementById('close-login').addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        window.addEventListener('click', function(e) {
            if (e.target === adminLoginModal) {
                adminLoginModal.style.display = 'none';
            }
            if (e.target === orderDetailModal) {
                orderDetailModal.style.display = 'none';
            }
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });

        // ä»·æ ¼é…å¥—é€‰æ‹©æŒ‰é’®
        document.querySelectorAll('.select-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (playlist.length === 0) {
                    showMessage('è¯·å…ˆæ·»åŠ æ­Œæ›²åˆ°æ­Œå•');
                    showPage('karaoke');
                    setActiveNav(document.getElementById('karaoke-nav'));
                    return;
                }
                
                if (!currentUser) {
                    showMessage('è¯·å…ˆç™»å½•ä»¥åˆ›å»ºè®¢å•');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                showOrderPage();
            });
        });

        // ç™»å½•æŒ‰é’®
        document.getElementById('login-btn').addEventListener('click', function() {
            loginModal.style.display = 'flex';
        });
    });

    // å…¨å±€å‡½æ•°ï¼ˆç”¨äºHTMLä¸­çš„onclickï¼‰
    window.viewOrderDetail = viewOrderDetail;
    window.updateOrderStatus = async function(orderId, newStatus) {
        const success = await updateOrderStatus(orderId, newStatus);
        if (success) {
            showMessage('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½æ•°æ®
            loadAdminData();
        } else {
            showMessage('è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥', 'warning');
        }
    };
</script>
</body>
</html>